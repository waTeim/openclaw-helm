{{- if .Values.config.create -}}
{{- $cfg := deepCopy .Values.config.data -}}
{{- $authMap := (include "openclaw.authMap" . | fromYaml) -}}

{{- $profiles := dict -}}
{{- range .Values.auth.providers }}
  {{- $spec := (get $authMap .) -}}
  {{- if not $spec }}{{ fail (printf "Unknown auth provider: %s" .) }}{{- end }}
  {{- $_ := set $profiles $spec.profileId (dict "mode" $spec.mode "provider" .) -}}
{{- end }}

{{- if not (hasKey $cfg "auth") -}}
{{- $_ := set $cfg "auth" (dict) -}}
{{- end -}}
{{- $_ := set $cfg.auth "profiles" $profiles -}}

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "openclaw.configMapName" . }}
  labels:
    {{- include "openclaw.labels" . | nindent 4 }}
data:
  openclaw.json: |
    {{ $cfg | toJson | nindent 4 }}
{{- end }}
