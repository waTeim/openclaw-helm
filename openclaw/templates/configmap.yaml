{{- if .Values.config.create -}}
{{- $cfg := deepCopy .Values.config.data -}}

{{- $profiles := dict -}}
{{- range .Values.authProfiles }}
{{- $_ := set $profiles .id (dict "mode" .mode "provider" .provider) -}}
{{- end -}}

{{- if not (hasKey $cfg "auth") -}}
{{- $_ := set $cfg "auth" (dict) -}}
{{- end -}}
{{- $_ := set $cfg.auth "profiles" $profiles -}}

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "openclaw.configMapName" . }}
  labels:
    {{- include "openclaw.labels" . | nindent 4 }}
data:
  openclaw.json: |
    {{ $cfg | toJson | nindent 4 }}
{{- end }}